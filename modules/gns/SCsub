#!/usr/bin/env python
Import("env")
Import("env_modules")

env_gns = env_modules.Clone()

# Third-party object files  
thirdparty_obj = []

if env["builtin_gamenetworkingsockets"]:
    thirdparty_dir = "#thirdparty/gns/"
    
    # Add include paths for GameNetworkingSockets headers
    env_gns.Prepend(CPPPATH=[
        thirdparty_dir + "include/",
        thirdparty_dir + "src/",
        thirdparty_dir + "src/public/",
        thirdparty_dir + "src/common/",
        thirdparty_dir + "src/steamnetworkingsockets/",
        thirdparty_dir + "src/steamnetworkingsockets/clientlib/"
    ])
    
    # Define GameNetworkingSockets macros - minimal feature set
    env_gns.Append(CPPDEFINES=[
        "STEAMNETWORKINGSOCKETS_FOREXPORT", 
        "STEAMNETWORKINGSOCKETS_STATIC_LINK", 
        "STEAMNETWORKINGSOCKETS_OPENSOURCE",
        "STEAMNETWORKINGSOCKETS_DISABLE_ENCRYPTION"
    ])
    
    # Platform-specific configuration
    if env["platform"] == "linuxbsd":
        env_gns.Append(CPPDEFINES=["POSIX"])
        # Minimal dependencies - no protobuf or complex crypto
        env_gns.Append(LIBS=["pthread", "dl", "rt"])
    
    # Link the static library directly
    import os
    lib_path = Dir(thirdparty_dir + "build").abspath + "/libGameNetworkingSockets.a"

    if os.path.exists(lib_path):
        # Add the library to the global environment for final linking
        env.Append(LIBS=[File(lib_path)])
        print("Added GameNetworkingSockets static library: " + lib_path)
    else:
        print("Warning: GameNetworkingSockets static library not found at: " + lib_path)

# Godot module source files
module_obj = []
env_gns.add_source_files(module_obj, "*.cpp")
env.modules_sources += module_obj

print("Added GameNetworkingSockets module with stubs for missing dependencies")

# Force rebuilding module when thirdparty library changes
if os.path.exists(lib_path):
    env.Depends(module_obj, lib_path)

# NOTE: All libraries are handled in the module-specific environment above
# Do not modify the global env to avoid breaking other modules